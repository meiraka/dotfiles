#!/bin/bash

if [ ! -L "$0" ]; then
  echo dotfiles is not installed
  exit 1
fi
ROOT=$(cd $(dirname "$(readlink "$0")"); cd ../..; pwd)

cd ${ROOT}

ARGS=()
ARGS+=${@##${HOME}/.}

# add checks files are exist in git repository.
add() {
    first=1
    for i in $@; do
        if [ "$first" != "1" ]; then
            ORIG="${HOME}/.$i"
            if [ ! -e "${ORIG}" ]; then
                echo ${ORIG} does not exist
                exit 1
            fi
        fi
        first=0
    done

    first=1
    changed=0
    for i in $@; do
        if [ "$first" != "1" ]; then
            ORIG="${HOME}/.$i"
            if [ ! -e "$i" ]; then
                echo copy ${ORIG} to ${ROOT}
                cp ${ORIG} ${ROOT}/$i
                changed=1
            fi
        fi
        first=0
    done
    if [ "$changed" = "1" ]; then
        make link
    fi
}

if [ "$#" = 0 ]; then
    git
elif [ "$1" = "add" ]; then
    add $ARGS
elif [ "$1" = "link" ]; then
    make link
    exit 0
fi
git $ARGS
